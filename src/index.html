<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>扫码测试页面</title>
  <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
  <link rel="stylesheet" href="./lib/layui/css/layui.css">
  <script src="./lib/layui/layui.all.js"></script>
  <style>
    body {
      padding: 30px;
    }
    .layui-col-xs6 img{
      width: 150px;
      height: auto;
    }
    .mybtn {
      margin: 20px;
    }
    .myqr {
      padding: 20px;
    }
    .hide {
      display: none;
    }
    .btn-re, .btn-list {
      padding: 10px;
    }
    .qrcode {
      padding: 16px;
    }

  </style>
</head>
<body>
  <div class="layui-container" style="text-align:center">
    <div class="layui-row">
      <h4>扫码付款demo演示</h4>
      <ul>
        <li>二维码根据用户选择动态生成不同的订单</li>
        <li>二维码生成后可手动取消当前订单</li>
        <li>订单生成后采用轮询方式确定订单是否支付完成</li>
        <li>若未在规定时间内完成支付,则自动取消订单 暂定 为 2m</li>
      </ul>
        <div class="layui-col-xs6">
          <div class="grid-demo grid-demo-bg1">
              <img src="http://www.savesafe.com.tw/ProdImg/1000/964/00/1000964_00_main.jpg" alt="">
              
              <div class="mybtn" data-amount="500" data-body="可口可乐" data-subject="超级好喝的可乐" data-order_no="001" data-currency='cny'>
                  <p class="subject">可乐</p>
                  <p>价格：５￥</p>
                  
                  <div class="btn-list">
                      <button class="layui-btn wechat" data-channel="wx_pub_qr" data-product_id="001">微信支付</button>
                      <button class="layui-btn layui-btn-normal" data-channel="alipay_qr">支付宝</button>
                  </div>
                  <!-- 重新生成 -->
                  <div class="btn-re hide">
                      <button class="layui-btn layui-btn-danger">重新选择</button>
                   </div>

                  <div class="myqr">
                      <p>二维码显示位置</p>
                      <div class="qrcode"></div>
                    </div>
              </div>

          </div>
        </div>
        <div class="layui-col-xs6">
          <div class="grid-demo">
              <img src="http://www.sanhuangzi.com/Storage/master/product/images/4dfe8c2bc71c431a8a2d3790776a8886.jpg" alt="">

              
              <div class="mybtn" data-amount="50" data-body="好用的纸巾" data-subject="好用的纸巾" data-order_no="002" data-currency='cny'>
                  <p class="subject">纸巾 </p>
                  <p>价格：０．５￥</p>

                 <div class="btn-list">
                    <button class="layui-btn wechat" data-channel="wx_pub_qr" data-product_id="001">微信支付</button>
                    <button class="layui-btn layui-btn-normal" data-channel="alipay_qr">支付宝</button>
                 </div>

                 <div class="btn-re hide">
                    <button class="layui-btn layui-btn-danger">重新选择</button>
                 </div>

                  <div class="myqr">
                      <p>二维码显示位置</p>
                      <div class="qrcode"></div>
                    </div>
              </div>

          </div>
        </div>
      </div>

      <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
          <legend>服务端返回结果</legend>
        </fieldset>
        <pre class="layui-code" lay-title="JavaScript" lay-skin="notepad" id="res" style="text-align: left">
          a = {
            jdi: 'test'
          }
        </pre>
            
  </div>
    
  <script>
    window.channel = ''
    
    $('.mybtn').on('click', function (e) {
      let el = $(this)
      if ($(e.target).hasClass('layui-btn-danger')) {  // 清空当前订单
        el.find('.qrcode').html('') // 清空二维码
        el.find('.btn-re, .btn-list').toggleClass('hide')  // 按钮转换

      } else if ($(e.target).hasClass('layui-btn')) { // 生新订单

        let data = handleClick(e, el)  // 订单数据
      
        create(el, data)  // 生成订单
      }
      
    })

    // 点击处理函数
    function handleClick (e, el) {
      var data = el.data()　　// 获取post数据
      let target = $(e.target)　　 // 获取点击对象

      data.channel = target.data('channel')  // 支付方式添加
      window.channel = data.channel  // 添加全局对象
      
      if (target.hasClass('wechat')) {　　// 微信判断
        data.extra = {
          product_id: target.data('product_id')
        }
      }
      return data
    }

    // 订单生成函数
    function create (el, data) {
      // 打开加载层
      // layer.load(1, {time: 4*1000,shade:0.6}) 
      
      layer.msg('订单生成中', {
        icon: 16
        ,shade: 0.6
      })

      el.find('.btn-list').addClass('hide')  // 禁用点击
      el.find('.btn-re').removeClass('hide') // 显示重新生成

      $.ajax({
        type: "POST",
        url: '/ping/charge',
        data: data,
        success: function (res) {
          su_post (res, el)
        },
        err: function (e) {
          console.log(e)
        },
        dataType: 'json',
      })
    }
    
    // 订单成功函数
    function su_post (res, el) {

      layer.closeAll('msg')  // 关闭加载层
      // el.find('button').removeClass('layui-btn-disabled')  //　可点

      $('#res').html(JSON.stringify(res))  // 填充服务器返回数据

      let target = el.find('.qrcode')
      
      let btn = el.find('btn-list　button')  //　获取按钮组
      let url = res.credential[window.channel]

      console.log(url)

      crQrCode(target, url)  // 生成二维码
    }

    // 二维码生成函数
    // target 为添加　二维码　位置
    // url 扫码地址
    function crQrCode (target, url) {
      $(target).qrcode({
        width: 150,
        height: 150,
        text: url,
      })
    }



    
  </script>
</body>
</html>