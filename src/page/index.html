<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>iClean纸巾</title>
  <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
  <link rel="stylesheet" href="page/lib/layui/css/layui.css">
  <script src="page/lib/layui/layui.all.js"></script>
  <style>
    body {
      padding: 30px;
    }
    .h3 {
        font-size: 20px;
    }
    .layui-col-xs6 img{
      width: 150px;
      height: auto;
    }
    .mybtn {
      margin: 20px;
    }
    .myqr {
      padding: 20px;
    }
    .hide {
      display: none;
    }
    .btn-re, .btn-list {
      padding: 10px;
    }
    .qrcode {
      padding: 16px;
    }
    .layui-col-md12 img {
        padding: 15px 0;
        width: 100%;
        height: auto;
    }

  </style>
</head>
<body>
  <div class="layui-container" style="text-align:center">
    

    <div class="layui-row">
      
      <div class="layui-form-item">

        <div>
            <h3 class="h3" id="title">标题</h3>
            <p id="subtitle">副标题</p>

        <div class="layui-col-md12 pic">
            <img id="prodimg" src="http://img-qncdn2.meilijia.com/photos/2ec2d06ceb71a9cabd71dd271fae2aa7_s730.jpg" alt="纸巾图片">
        </div>
        <p style="text-align: left; padding: 15px;">单价：<span id="price">0.1</span>￥</p>
        </div>
        <label style="text-align: left;" class="layui-form-label">购买数量</label>
        <div class="layui-input-block">
            <input id="prodCount" type="text" value="1" name="title" required  lay-verify="required" placeholder="请输入数量" autocomplete="off" class="layui-input">
        </div>
        </div>
        <button class="layui-btn" id="my_create">微信支付</button>

        
      


       
      </div>

      <div style="display: none">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
          <legend>服务端返回结果</legend>
        </fieldset>
        <pre class="layui-code" lay-title="JavaScript" lay-skin="notepad" id="res" style="text-align: left">
          a = {
            jdi: 'test'
          }
        </pre>
      </div>
            
  </div>
    
  <script>
    var title, subtitle, price, pic, device_info
    var LO = window.location.host
    var BASE_URL = 'https://' + LO
    function getUrlParameter(sParam) {
      var sPageURL = decodeURIComponent(window.location.search.substring(1)),
          sURLVariables = sPageURL.split('&'),
          sParameterName,
          i;

      for (i = 0; i < sURLVariables.length; i++) {
          sParameterName = sURLVariables[i].split('=')

          if (sParameterName[0] === sParam) {
              return sParameterName[1] === undefined ? '' : sParameterName[1];
          }
      }
    }
    // 获取商品信息
    +function () {
      var id = getUrlParameter('id')
      let prodCount = $('#prodCount').val()
      if (!id) return false
      $.ajax({
        type: "GET",
        url: BASE_URL + '/wepay/findProductByid',
        data: {id: id},
        success: function (data) {
          title       = data.data.title
          subtitle    = data.data.subtitle
          price       = Number(data.data.price)/100 * prodCount
          pic         = data.data.pic
          device_info = data.data.device_info
          // 页面页面填充
          $('#title').text(title)
          $('#subtitle').text(subtitle)
          $('#price').text(price)
          $('#pic').attr('src', subtitle)
        },
        err: function (e) {
          console.log(e)
        },
        dataType: 'json',
      })
    }()
    
    // 订单生成函数
    function create (el) {
      // 打开加载层
      // layer.load(1, {time: 4*1000,shade:0.6}) 
      var data = {
        device_info: device_info,
        total_fee: Number(price) * 100,
        body: title,
        trade_type: 'MWEB',
        detail: subtitle,
        notify_url: BASE_URL + '/wepay/wescancall/'
      }

      layer.msg('订单生成中', {
        icon: 16
        ,shade: 0.6
      })


      el.find('.btn-list').addClass('hide')  // 禁用点击
      el.find('.btn-re').removeClass('hide') // 显示重新生成

      $.ajax({
        type: "POST",
        url: BASE_URL + '/wepay/create',
        data: data,
        success: function (res) {
          console.log(res.xml.mweb_url)
          var targetU = res.xml.mweb_url
          console.log(targetU)
          window.location.href = targetU
        },
        err: function (e) {
          console.log(e)
        },
        dataType: 'json',
      })
    }

    $('#my_create').on('click', function () {
      console.log('click')
      create($(this))
    })





    
  </script>
</body>
</html>